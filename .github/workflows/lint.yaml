name: Lint OAS & Terraform resources
on:
  pull_request:
#    paths:
#      - "schemas/automation-api-oas.yaml"
jobs:
  lint:
    permissions:
      contents: read
    runs-on:
      - ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ github.event.pull_request.head.ref }}
      - uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6
        with:
          go-version-file: go.mod
      - name: Get speakeasy version
        id: speakeasy-version
        run: |
          VERSION=$(grep 'speakeasyVersion:' .speakeasy/workflow.yaml | sed -e 's/speakeasyVersion: //')
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
      - name: Install Speakeasy
        uses: mheap/setup-go-cli@fa9b01cdd4115eac636164f0de43bf7d51c82697 #
        with:
          owner: speakeasy-api
          repo: speakeasy
          cli_name: speakeasy
          package_type: zip
          version: ${{ steps.speakeasy-version.outputs.version }}
      - name: Configure speakeasy CLI
        run: |
          mkdir -p ~/.speakeasy
          echo 'speakeasy_api_key: ${{ secrets.SPEAKEASY_API_KEY }}' > ~/.speakeasy/config.yaml
      - uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3.1.2
        with:
          terraform_wrapper: false
      - name: Generate
        run: make speakeasy
      - name: Check repo is clean
        run: |
          # Remove speakeasy cli
          rm -fR speakeasy-${{ steps.speakeasy-version.outputs.version }}-linux
          
          # Ignore changes to workflow.lock
          git checkout -- .speakeasy/workflow.lock
          
          git add .
          
          if [[ -n "$(git status --porcelain)" ]]; then
            export PAGER= # don't let `git diff` invoke `less`
            git diff --cached        
            exit 1
          fi
      - name: Run lint
        run: make lint
