name: Terraform Provider Tests

on:
  push:
    branches-ignore:
      - master

env:
  APIM_SERVER_URL: ${{ vars.TEST_SERVER_URL_MASTER }}

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

jobs:
  pre-test-validation:
    name: Pre-test validation
    permissions:
      contents: "read"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Setup builder
        uses: ./.github/actions/setup-go
      - name: Setup terraform
        uses: ./.github/actions/setup-terraform
        with:
          terraform_version: "1.12.*"
      - name: Run pre-tests using ${{ env.APIM_SERVER_URL }} - user ${{ vars.APIM_ADMIN_USERNAME }}
        env:
          APIM_USERNAME: ${{ vars.APIM_ADMIN_USERNAME }}
          APIM_PASSWORD: ${{ secrets.APIM_ADMIN_PASSWORD }}
        run: make pre-test
      - name: Run pre-tests using ${{ env.APIM_SERVER_URL }} - user ${{ vars.APIM_API1_USERNAME }}
        env:
          APIM_USERNAME: ${{ vars.APIM_API1_USERNAME }}
          APIM_PASSWORD: ${{ secrets.APIM_API1_PASSWORD }}
        run: make pre-test
  acceptance:
    name: Acceptance Tests (Terraform ${{ matrix.terraform-version }})
    runs-on: ubuntu-latest
    needs:
      - pre-test-validation
    permissions:
      contents: "read"
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        terraform-version:
          - "1.10.*"
          - "1.11.*"
          - "1.12.*"
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Setup go
        uses: ./.github/actions/setup-go
      - name: Setup terraform
        uses: ./.github/actions/setup-terraform
        with:
          terraform_version: ${{ matrix.terraform-version }}
      - name: Run Acceptance & Example using ${{ vars.TEST_SERVER_URL_MASTER }}
        env:
          APIM_SERVER_URL: ${{ vars.TEST_SERVER_URL_MASTER }}
          APIM_USERNAME: ${{ secrets.TEST_USER }}
          APIM_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}
        run: make acceptance-tests examples-tests
