name: Terraform Provider Tests

on:
  push:
    branches-ignore:
      - main
  schedule:
    - cron: 00 05 * * 1-5

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

jobs:
  verify-oas:
    name: Verify OAS schema matches APIM main branch
    runs-on: ubuntu-latest
    continue-on-error: true
    permissions:
      contents: "read"
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Verify OAS schema matches upstream
        uses: ./.github/actions/verify-oas-upstream
      - name: Send slack notification
        if: (failure() || success()) && github.event.schedule != ''
        uses: ./.github/actions/send-slack-notification
        with:
          job_name: ${{ github.job }}
          job_status: ${{ job.status }}
          circleci_token: ${{ secrets.CIRCLECI_TOKEN }}
          trigger: test_results_notification

  pull-images:
    name: Pull Docker image (${{ matrix.image.cache_key }})
    runs-on: ubuntu-latest
    permissions:
      contents: "read"
    strategy:
      matrix:
        image:
          - name: apim-management-api
            tag: master-latest
            cache_key: apim-master-latest
          - name: apim-management-api
            tag: 4.9.x-latest
            cache_key: apim-4.9.x-latest
          - name: apim-management-api
            tag: 4.10.x-latest
            cache_key: apim-4.10.x-latest
          - name: mongo
            tag: 7.0.23-jammy
            cache_key: mongo-7.0.23-jammy
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Resolve image reference
        id: resolve
        shell: bash
        run: |
          if [[ "${{ matrix.image.name }}" == "mongo" ]]; then
            echo "ref=${{ matrix.image.name }}:${{ matrix.image.tag }}" >> "$GITHUB_OUTPUT"
          else
            REGISTRY=$(yq '.apim.image.registry' hack/apim.yaml)
            echo "ref=${REGISTRY}/${{ matrix.image.name }}:${{ matrix.image.tag }}" >> "$GITHUB_OUTPUT"
          fi
      - name: Restore image cache
        id: docker-cache
        uses: ./.github/actions/docker-cache-restore
        with:
          cache-key: docker-${{ github.ref_name }}-${{ matrix.image.cache_key }}-${{ hashFiles('hack/apim.yaml', 'hack/scripts/run-kind.mjs') }}
      - name: Pull image
        if: steps.docker-cache.outputs.cache-hit != 'true'
        shell: bash
        run: docker pull "${{ steps.resolve.outputs.ref }}"
      - name: Save image cache
        uses: ./.github/actions/docker-cache-save
        with:
          cache-key: docker-${{ github.ref_name }}-${{ matrix.image.cache_key }}-${{ hashFiles('hack/apim.yaml', 'hack/scripts/run-kind.mjs') }}
          images: ${{ steps.resolve.outputs.ref }}
          cache-hit: ${{ steps.docker-cache.outputs.cache-hit }}

  examples:
    needs: [pull-images]
    name: Run Terraform examples (Env ${{ matrix.apim.image_tag }} + Terraform/OpenTofu latest)
    runs-on: ubuntu-latest
    permissions:
      contents: "read"
    strategy:
      matrix:
        apim:
          - image_tag: master-latest
            chart_version: 4.11.*
          - image_tag: 4.9.x-latest
            chart_version: 4.9.*
          - image_tag: 4.10.x-latest
            chart_version: 4.10.*
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Restore MongoDB cache
        uses: ./.github/actions/docker-cache-restore
        with:
          cache-key: docker-${{ github.ref_name }}-mongo-7.0.23-jammy-${{ hashFiles('hack/apim.yaml', 'hack/scripts/run-kind.mjs') }}
      - name: Restore APIM image cache
        uses: ./.github/actions/docker-cache-restore
        with:
          cache-key: docker-${{ github.ref_name }}-apim-${{ matrix.apim.image_tag }}-${{ hashFiles('hack/apim.yaml', 'hack/scripts/run-kind.mjs') }}
      - name: Create test cluster
        uses: ./.github/actions/create-test-cluster
        with:
          gravitee-license: ${{ secrets.GRAVITEE_LICENSE }}
          image-tag: ${{ matrix.apim.image_tag }}
          chart-version: ${{ matrix.apim.chart_version }}
      - name: Setup go
        uses: ./.github/actions/setup-go
      - name: Setup terraform
        uses: ./.github/actions/setup-terraform
        with:
          terraform_version: "latest"
      - name: Setup OpenTofu
        uses: ./.github/actions/setup-opentofu
        with:
          tofu_version: "latest"
      - name: Build provider
        shell: bash
        run: go build
      - name: Run examples using ${{ matrix.apim.image_tag }}
        env:
          APIM_SERVER_URL: http://localhost:30083/automation
          APIM_USERNAME: admin
          APIM_PASSWORD: admin
        run: make examples-tests
      - name: Send Slack notification
        if: (failure() || success()) && github.event.schedule != ''
        uses: ./.github/actions/send-slack-notification
        with:
          job_name: ${{ github.job }} - Version ${{ matrix.apim.image_tag }} - TF/Tofu latest
          job_status: ${{ job.status }}
          circleci_token: ${{ secrets.CIRCLECI_TOKEN }}
          trigger: test_results_notification

  acceptance:
    needs: [pull-images]
    name: Acceptance Tests - Version ${{ matrix.apim.image_tag }} - Terraform ${{ matrix.terraform-version }}
    runs-on: ubuntu-latest
    permissions:
      contents: "read"
    strategy:
      fail-fast: false
      matrix:
        terraform-version:
          - "1.9.*"
          - "1.14.*"
        apim:
          - image_tag: master-latest
            chart_version: 4.11.*
          - image_tag: 4.9.x-latest
            chart_version: 4.9.*
          - image_tag: 4.10.x-latest
            chart_version: 4.10.*
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Restore MongoDB cache
        uses: ./.github/actions/docker-cache-restore
        with:
          cache-key: docker-${{ github.ref_name }}-mongo-7.0.23-jammy-${{ hashFiles('hack/apim.yaml', 'hack/scripts/run-kind.mjs') }}
      - name: Restore APIM image cache
        uses: ./.github/actions/docker-cache-restore
        with:
          cache-key: docker-${{ github.ref_name }}-apim-${{ matrix.apim.image_tag }}-${{ hashFiles('hack/apim.yaml', 'hack/scripts/run-kind.mjs') }}
      - name: Create test cluster
        uses: ./.github/actions/create-test-cluster
        with:
          gravitee-license: ${{ secrets.GRAVITEE_LICENSE }}
          image-tag: ${{ matrix.apim.image_tag }}
          chart-version: ${{ matrix.apim.chart_version }}
      - name: Setup go
        uses: ./.github/actions/setup-go
      - name: Setup terraform
        uses: ./.github/actions/setup-terraform
        with:
          terraform_version: ${{ matrix.terraform-version }}
      - name: Run acceptance tests
        env:
          APIM_SERVER_URL: http://localhost:30083/automation
          APIM_USERNAME: admin
          APIM_PASSWORD: admin
        run: make acceptance-tests
      - name: Send Slack notification
        if: (failure() || success()) && github.event.schedule != ''
        uses: ./.github/actions/send-slack-notification
        with:
          job_name: ${{ github.job }} - Version ${{ matrix.apim.image_tag }} - Terraform ${{ matrix.terraform-version }}
          job_status: ${{ job.status }}
          circleci_token: ${{ secrets.CIRCLECI_TOKEN }}
          trigger: test_results_notification

  unit:
    name: Unit tests
    runs-on: ubuntu-latest
    permissions:
      contents: "read"
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Setup go
        uses: ./.github/actions/setup-go
      - name: Run unit tests
        run: make unit-tests
