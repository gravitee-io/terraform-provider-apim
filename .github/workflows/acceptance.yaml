name: Terraform Provider Tests

on:
  pull_request:
  push:
    branches-ignore:
      - master

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

jobs:
  acceptance:
    name: Acceptance Tests (Terraform ${{ matrix.terraform-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        terraform-version:
          - "1.10.*"
          - "1.11.*"
          - "1.12.*"
    if: github.event_name == 'pull_request' || (github.event_name == 'push' && github.event.pull_request == null)
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Setup go
        uses: ./.github/actions/setup-go
      - uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3.1.2
        with:
          terraform_version: ${{ matrix.terraform-version }}
          terraform_wrapper: false
      - name: Setup local TF Provider
        run: ./tests/examples/setup-local-provider.sh
      - name: Build provider
        run: go build
      - name: Run Acceptance & Example using ${{ vars.TEST_SERVER_URL_MASTER }}
        env:
          APIM_SERVER_URL: ${{ vars.TEST_SERVER_URL_MASTER }}
          APIM_USERNAME: ${{ secrets.TEST_USER }}
          APIM_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}
          APIM_API1_USERNAME: ${{ secrets.TEST_USER2 }}
          APIM_API1_PASSWORD: ${{ secrets.TEST_USER2_PASSWORD }}
        run: make acceptance-tests examples-tests
