name: Terraform Provider Tests

on:
  push:
    branches-ignore:
      - master
  schedule:
    - cron: 00 05 * * 1-5

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

jobs:
  verify-oas:
    name: Verify OAS schema matches APIM main branch
    runs-on: ubuntu-latest
    continue-on-error: true
    permissions:
      contents: "read"
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Verify OAS schema matches upstream
        uses: ./.github/actions/verify-oas-upstream
      - name: Send slack notification
        if: (failure() || success()) && github.event.schedule != ''
        uses: ./.github/actions/send-slack-notification
        with:
          job_name: ${{ github.job }}
          job_status: ${{ job.status }}
          circleci_token: ${{ secrets.CIRCLECI_TOKEN }}
          trigger: test_results_notification
  pre-test-validation:
    name: Pre-test validation
    permissions:
      contents: "read"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        env:
          - name: Kind
            url: http://localhost:30083/automation
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Cache Docker images
        id: docker-cache
        uses: actions/cache@v4
        with:
          path: /tmp/docker-images.tar
          key: docker-${{ runner.os }}-${{ hashFiles('hack/apim.yaml', 'hack/scripts/run-kind.mjs') }}
      - name: Restore Docker images from cache
        if: steps.docker-cache.outputs.cache-hit == 'true'
        run: docker load -i /tmp/docker-images.tar
      - name: Create test cluster
        run: make start-cluster
      - name: Save Docker images for cache
        if: steps.docker-cache.outputs.cache-hit != 'true'
        run: >
          docker images --format '{{.Repository}}:{{.Tag}}'
          | grep -E '(apim-gateway|apim-management-api|apim-management-ui|mongo|go-httpbin)'
          | xargs docker save -o /tmp/docker-images.tar
      - name: Setup builder
        uses: ./.github/actions/setup-go
      - name: Setup terraform
        uses: ./.github/actions/setup-terraform
        with:
          terraform_version: "latest"
      - name: Run pre-tests using ${{ matrix.env.name }} - user admin
        env:
          APIM_SERVER_URL: ${{ matrix.env.url }}
          APIM_USERNAME: admin
          APIM_PASSWORD: admin
        run: make pre-test
      - name: Run pre-tests using ${{ matrix.env.name }} - user api1
        env:
          APIM_SERVER_URL: ${{ matrix.env.url }}
          APIM_USERNAME: api1
          APIM_PASSWORD: api1
        run: make pre-test
      - name: Send Slack notification on failure
        if: failure() && github.event.schedule != ''
        uses: ./.github/actions/send-slack-notification
        with:
          job_name: ${{ github.job }} - ${{ matrix.env.name }}
          job_status: ${{ job.status }}
          circleci_token: ${{ secrets.CIRCLECI_TOKEN }}
          trigger: test_results_notification
  examples:
    name: Run Terraform examples (Env ${{ matrix.env.name }} + Terraform/OpenTofu latest)
    runs-on: ubuntu-latest
    needs:
      - pre-test-validation
    permissions:
      contents: "read"
    strategy:
      matrix:
       env:
          - name: Kind
            url: http://localhost:30083/automation
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Cache Docker images
        id: docker-cache
        uses: actions/cache@v4
        with:
          path: /tmp/docker-images.tar
          key: docker-${{ runner.os }}-${{ hashFiles('hack/apim.yaml', 'hack/scripts/run-kind.mjs') }}
      - name: Restore Docker images from cache
        if: steps.docker-cache.outputs.cache-hit == 'true'
        run: docker load -i /tmp/docker-images.tar
      - name: Create test cluster
        run: make start-cluster
      - name: Save Docker images for cache
        if: steps.docker-cache.outputs.cache-hit != 'true'
        run: >
          docker images --format '{{.Repository}}:{{.Tag}}'
          | grep -E '(apim-gateway|apim-management-api|apim-management-ui|mongo|go-httpbin)'
          | xargs docker save -o /tmp/docker-images.tar
      - name: Setup go
        uses: ./.github/actions/setup-go
      - name: Setup terraform
        uses: ./.github/actions/setup-terraform
        with:
          terraform_version: "latest"
      - name: Setup OpenTofu
        uses: ./.github/actions/setup-opentofu
        with:
          tofu_version: "latest"
      - name: Build provider
        shell: bash
        run: go build
      - name: Run examples using ${{ matrix.env.url }}
        env:
          APIM_SERVER_URL: ${{ matrix.env.url }}
          APIM_USERNAME: admin
          APIM_PASSWORD: admin
        run: make examples-tests
      - name: Send Slack notification
        if: (failure() || success()) && github.event.schedule != ''
        uses: ./.github/actions/send-slack-notification
        with:
          job_name: ${{ github.job }} - Env ${{ matrix.env.name }} + Terraform ${{ matrix.terraform-version }})
          job_status: ${{ job.status }}
          circleci_token: ${{ secrets.CIRCLECI_TOKEN }}
          trigger: test_results_notification

  acceptance:
    name: Acceptance Tests (Env ${{ matrix.env.name }} + Terraform ${{ matrix.terraform-version }})
    runs-on: ubuntu-latest
    needs:
      - pre-test-validation
    permissions:
      contents: "read"
    strategy:
      fail-fast: false
      matrix:
        terraform-version:
          - "1.10.*"
          - "1.11.*"
          - "1.12.*"
          - "1.13.*"
          - "1.14.*"
        env:
          - name: Kind
            url: http://localhost:30083/automation
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Cache Docker images
        id: docker-cache
        uses: actions/cache@v4
        with:
          path: /tmp/docker-images.tar
          key: docker-${{ runner.os }}-${{ hashFiles('hack/apim.yaml', 'hack/scripts/run-kind.mjs') }}
      - name: Restore Docker images from cache
        if: steps.docker-cache.outputs.cache-hit == 'true'
        run: docker load -i /tmp/docker-images.tar
      - name: Create test cluster
        run: make start-cluster
      - name: Save Docker images for cache
        if: steps.docker-cache.outputs.cache-hit != 'true'
        run: >
          docker images --format '{{.Repository}}:{{.Tag}}'
          | grep -E '(apim-gateway|apim-management-api|apim-management-ui|mongo|go-httpbin)'
          | xargs docker save -o /tmp/docker-images.tar
      - name: Setup go
        uses: ./.github/actions/setup-go
      - name: Setup terraform
        uses: ./.github/actions/setup-terraform
        with:
          terraform_version: ${{ matrix.terraform-version }}
      - name: Run acceptance tests using ${{ matrix.env.url }}
        env:
          APIM_SERVER_URL: ${{ matrix.env.url }}
          APIM_USERNAME: admin
          APIM_PASSWORD: admin
        run: make acceptance-tests
      - name: Send Slack notification
        if: (failure() || success()) && github.event.schedule != ''
        uses: ./.github/actions/send-slack-notification
        with:
          job_name: ${{ github.job }} - Env ${{ matrix.env.name }} + Terraform ${{ matrix.terraform-version }}
          job_status: ${{ job.status }}
          circleci_token: ${{ secrets.CIRCLECI_TOKEN }}
          trigger: test_results_notification

  unit:
    name: Unit tests
    runs-on: ubuntu-latest
    continue-on-error: true
    permissions:
      contents: "read"
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Setup go
        uses: ./.github/actions/setup-go
      - name: Run unit tests
        run: make unit-tests
