version: 2.1

orbs:
  keeper: gravitee-io/keeper@0.7.0
  slack: circleci/slack@6.1.1

parameters:
  trigger:
    type: enum
    default: none
    enum:
      - test_results_notification
      - release_notification
      - none
  job_name:
    type: string
    default: ""
  job_url:
    type: string
    default: ""
  job_status:
    type: enum
    default: fail
    enum:
      - pass
      - fail
  branch_name:
    type: string
    default: ""
  release_version:
    type: string
    default: ""

jobs:
  notify-slack:
    docker:
      - image: cimg/base:stable
    resource_class: small
    steps:
      - keeper/env-export:
          secret-url: keeper://ZOz4db245GNaETVwmPBk8w/field/password
          var-name: SLACK_ACCESS_TOKEN
      - run:
          name: Convert parameter to environment variable
          command: |
            # Export the parameter value to BASH_ENV
            echo 'JOB="<< pipeline.parameters.job_name >>"' >> $BASH_ENV
            echo 'JOB_URL="<< pipeline.parameters.job_url >>"' >> $BASH_ENV
            echo 'BRANCH_NAME="<< pipeline.parameters.branch_name >>"' >> $BASH_ENV
            
            if [[ "<< pipeline.parameters.job_status >>" == "pass" ]]; then
              echo 'STATUS=succeeded' >> $BASH_ENV
              echo 'STATUS_ICON=white_check_mark' >> $BASH_ENV
            else
              echo 'STATUS=failed' >> $BASH_ENV
              echo 'STATUS_ICON=red_circle' >> $BASH_ENV
            fi
      - slack/notify:
          channel: C0A2R4W3MLM
          event: always
          custom: |
            {
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Job ${STATUS}*. :${STATUS_ICON}:\n*Project*: :terraform: APIM Terraform provider\n*Job*: ${JOB}\n*Branch*: ${BRANCH_NAME}\n"
                  }
                },
                {
                  "type": "divider"
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "GitHub job",
                        "emoji": true
                      },
                      "value": "click_me_123",
                      "url": "${JOB_URL}"
                    }
                  ]
                }
              ]
            }

  notify-release:
    docker:
      - image: cimg/base:stable
    resource_class: small
    steps:
      - keeper/env-export:
          secret-url: keeper://ZOz4db245GNaETVwmPBk8w/field/password
          var-name: SLACK_ACCESS_TOKEN
      - run:
          name: Validate version parameter
          command: |
            VERSION="<< pipeline.parameters.release_version >>"
            if [[ -z "$VERSION" ]]; then
              echo "Version parameter is empty"
              exit 1
            fi
            
            # Check if version starts with 'v' and follows semver pattern
            if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?(\+[a-zA-Z0-9.-]+)?$ ]]; then
              echo "Version must be a valid semver starting with 'v' (e.g., v1.2.3)"
              exit 1
            fi
            
            echo "VERSION=$VERSION" >> $BASH_ENV
      - slack/notify:
          channel: C02NGT20S4W
          event: always
          custom: |
            {
              "text": ":terraform: Terraform provider - Version ${VERSION} released! :ramen:"
            }

workflows:
  send-notification:
    when:
      equal:
        - << pipeline.parameters.trigger >>
        - test_results_notification
    jobs:
      - notify-slack:
          name: Send test result notification
          context: cicd-orchestrator

  release-notification:
    when:
      equal:
        - << pipeline.parameters.trigger >>
        - release_notification
    jobs:
      - notify-release:
          name: Send release notification
          context: cicd-orchestrator